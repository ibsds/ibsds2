<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
  <title>OSI Layer Quiz Game</title>
  <style>
    /* --- MODIFIED: Global Space/Cosmos Theme --- */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #f0f0f5;
      /* MODIFIED: Body now has the space gradient background */
      background: linear-gradient(to bottom, #0a0e27 0%, #1a1a3e 50%, #16213e 100%);
      overflow-x: hidden;
    }

    /* NEW: Animated Starfield Background is now global */
    body::before {
      content: '';
      position: fixed; /* Use fixed to cover the whole viewport */
      top: 0;
      left: 0;
      width: 200%;
      height: 200%;
      background-image: 
        radial-gradient(2px 2px at 20px 30px, #eee, transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 50px 50px, #fff, transparent),
        radial-gradient(1px 1px at 80px 10px, rgba(255,255,255,0.6), transparent),
        radial-gradient(2px 2px at 130px 80px, #ddd, transparent);
      background-repeat: repeat;
      background-size: 200px 200px;
      animation: starsMove 120s linear infinite;
      z-index: -1;
    }
    @keyframes starsMove {
      from { transform: translateX(0); }
      to { transform: translateX(-200px); }
    }

    /* --- Start Page Specific Styles --- */
    #start-page-container {
      position: relative;
      background: transparent; /* Keep it transparent */
      animation: pageFadeIn 1s ease-out;
      border: none;
      box-shadow: none;
    }
    @keyframes pageFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Override title styles for the start page */
    #start-page-container .game-title {
      color: #ffffff; /* Bright white */
      text-shadow: 0 0 10px #ffffff, 0 0 20px #6495ed, 0 0 30px #6495ed;
      animation: titleGlow 3s ease-in-out infinite alternate;
    }
    @keyframes titleGlow {
      from { text-shadow: 0 0 10px #ffffff, 0 0 20px #6495ed, 0 0 30px #6495ed; }
      to { text-shadow: 0 0 15px #ffffff, 0 0 25px #87ceeb, 0 0 35px #87ceeb; }
    }
    
    /* Override paragraph text color */
    #start-page-container p {
      color: #b0c4de; /* Light steel blue */
      text-shadow: 0 0 5px #b0c4de;
    }

    /* Override Visual Layer Stack for Glass Panel Effect */
    #start-page-container #layer-visual-stack .visual-layer {
      background: rgba(255, 255, 255, 0.05); /* Very transparent white */
      border: 1px solid rgba(100, 149, 237, 0.3);
      color: #e6e6fa; /* Lavender */
      box-shadow: 0 0 10px rgba(100, 149, 237, 0.3), inset 0 0 10px rgba(255, 255, 255, 0.1);
      text-shadow: 0 0 3px #e6e6fa;
      backdrop-filter: blur(4px);
    }

    /* Override Start Button for Nebula Effect */
    #start-page-container #startGameBtn {
      background: linear-gradient(45deg, #4b0082, #6495ed);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 15px rgba(100, 149, 237, 0.5), inset 0 0 10px rgba(255, 255, 255, 0.2);
      animation: buttonNebulaPulse 2s ease-in-out infinite;
    }
    #start-page-container #startGameBtn:hover {
      background: linear-gradient(45deg, #6a0dad, #87ceeb);
      box-shadow: 0 0 20px rgba(100, 149, 237, 0.7), inset 0 0 15px rgba(255, 255, 255, 0.3);
    }
    @keyframes buttonNebulaPulse {
      0%, 100% { box-shadow: 0 0 15px rgba(100, 149, 237, 0.5), inset 0 0 10px rgba(255, 255, 255, 0.2); }
      50% { box-shadow: 0 0 25px rgba(100, 149, 237, 0.7), inset 0 0 15px rgba(255, 255, 255, 0.3); }
    }


    /* --- Main Game Styles --- */
    .game-container {
      width: 90%;
      max-width: 600px;
      padding: 1rem;
      box-sizing: border-box;
    }
    .game-title {
      text-align: center;
      font-size: 2.4rem;
      font-weight: 900;
      margin-bottom: 25px;
      color: #8a8aff;
      text-shadow: 0 0 8px #8a8affaa;
      user-select: none;
    }
    #questionNumber {
      font-weight: 600;
      font-size: 1.2rem;
      margin-bottom: 8px;
      color: #a0a0ff;
      /* CORRECTED: Added text-align: center */
      text-align: center;
    }
    #question {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 20px;
      line-height: 1.3;
      /* CORRECTED: Added text-align: center */
      text-align: center;
    }
    .OSI-Layers {
      list-style: none;
      padding: 0;
      margin-bottom: 25px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    .OSI-Layers li {
      background: #2e2e4e;
      color: #d7d7ff;
      padding: 14px 20px;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      flex: 1 1 45%;
      max-width: 250px;
      text-align: center;
      font-weight: 600;
      transition: background-color 0.3s ease, color 0.3s ease, transform 0.3s ease;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
    }
    .OSI-Layers li:hover {
      background-color: #4a4ad8;
      transform: scale(1.05);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
    }
    .OSI-Layers li.selected {
      background: #444444;
      color: #ddd;
      font-weight: 700;
      border: 2px solid #bbbbbb;
      box-shadow: 0 0 6px #999999aa;
      transform: scale(0.97);
      transition: transform 0.2s ease;
      pointer-events: none;
    }
    .OSI-Layers li.disabled {
      opacity: 0.5;
      pointer-events: none;
      cursor: default;
    }
    #feedback {
      font-size: 1.1rem;
      min-height: 1.5em;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
      border-radius: 6px;
      padding: 8px 12px;
      transition: background-color 0.4s ease, color 0.4s ease;
    }
    .correct-feedback {
      background-color: #28a745;
      color: #e6ffe6;
      box-shadow: 0 0 10px #28a745aa;
    }
    .incorrect-feedback {
      background-color: #dc3545;
      color: #ffd6d6;
      box-shadow: 0 0 10px #dc3545aa;
    }
    /* Animations */
    @keyframes correctFlash {
      0%, 100% { background-color: #28a745; }
      50% { background-color: #3ade60; }
    }
    @keyframes incorrectFlash {
      0%, 100% { background-color: #dc3545; }
      50% { background-color: #e85c6f; }
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .correct-feedback.animated {
      animation: correctFlash 0.8s ease-in-out;
    }
    .incorrect-feedback.animated {
      animation: incorrectFlash 0.8s ease-in-out, shake 0.6s ease-in-out;
    }
    .OSI-Layers li.correct-answer {
      border: 3px solid #ffc107;
      box-shadow: 0 0 15px #ffc107;
    }
    #score, #highScore {
      font-weight: 600;
      font-size: 1rem;
      color: #b0b0ff;
      margin-bottom: 10px;
      text-align: center;
    }
    #timer {
      font-weight: 600;
      text-align: center;
      margin-bottom: 8px;
      color: #cfcfff;
    }
    #timerProgress {
      height: 12px;
      background: #5b5bc8;
      border-radius: 8px;
      transition: width 0.2s ease;
    }
    #timerBar {
      background: #2e2e4e;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 25px;
    }
    
    /* --- NEW: Game Control Buttons Styles --- */
    .game-controls-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    #restartBtn, #startGameBtn {
      padding: 12px 24px; /* Adjusted padding */
      background: #5b5bc8;
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 6px 12px rgba(91, 91, 200, 0.6);
      transition: background-color 0.3s ease;
    }
    #restartBtn:hover {
      background: #4545a8;
    }
    #startGameBtn {
      display: block; /* Keep this for the start page */
      width: 180px;
      margin: 0 auto;
    }

    #backToDifficultyBtn {
      padding: 12px 24px;
      background: transparent;
      border: 2px solid #5b5bc8;
      border-radius: 10px;
      color: #5b5bc8;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    #backToDifficultyBtn:hover {
      background: #5b5bc8;
      color: #fff;
    }

    .OSI-Layers li:focus {
      outline: 3px solid #8a8aff;
      outline-offset: 3px;
    }
    .new-high-score {
      font-size: 1.3rem;
      font-weight: bold;
      color: #ffcd38;
      text-shadow: 0 0 8px #ffcd38;
      animation: pulse 1s infinite;
    }
    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
      z-index: 999;
      display: none;
    }
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #f0f; /* This is a placeholder, JS sets it */
      animation: confettiFall linear;
      animation-fill-mode: forwards; /* FIX: Keep the final state of the animation */
    }
    @keyframes confettiFall {
      0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    /* Progress dots styles */
    .progress-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px;
      gap: 8px;
    }
    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #3c3c3c;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }
    .progress-dot.active {
      background-color: #5b5bc8;
      transform: scale(1.2);
    }
    .progress-dot.completed {
      background-color: #28a745;
    }
    .progress-dot.incorrect {
      background-color: #dc3545;
    }
    .progress-legend {
      display: flex;
      justify-content: center;
      gap: 15px;
      font-size: 0.8rem;
      color: #a0a0ff;
      margin-bottom: 20px;
    }
    .progress-legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    /* Media queries for mobile devices */
    @media (max-width: 480px) {
      .game-container {
        width: 95%;
        padding: 0.8rem;
      }
      
      .game-title {
        font-size: 1.8rem;
        margin-bottom: 15px;
      }
      
      #question {
        font-size: 1.1rem;
        margin-bottom: 15px;
      }
      
      .OSI-Layers li {
        padding: 12px 15px;
        font-size: 0.9rem;
        flex: 1 1 100%; /* Make buttons full-width */
        max-width: 100%;
      }
      
      .progress-legend {
        font-size: 0.7rem;
        gap: 10px;
        flex-wrap: wrap;
      }
      
      #feedback {
        font-size: 1rem;
      }
      
      #score, #highScore {
        font-size: 0.9rem;
      }
      
      /* MODIFIED: Button styles for mobile */
      .game-controls-container {
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }
      #restartBtn, #backToDifficultyBtn, #startGameBtn {
        width: 160px;
        padding: 10px 0;
        font-size: 1rem;
      }
    }
    
    /* Extra small screens */
    @media (max-width: 360px) {
      .game-title {
        font-size: 1.6rem;
      }
      
      #question {
        font-size: 1rem;
      }
      
      .OSI-Layers li {
        padding: 10px 12px;
        font-size: 0.85rem;
      }
      
      .progress-legend {
        font-size: 0.65rem;
      }
    }

    /* Class to hide elements */
    .hidden {
      display: none;
    }

    /* --- Start Page Specific Styles (Originals, some now overridden) --- */

    /* RESTORED: Visual Layer Stack (without animation) */
    #layer-visual-stack {
      display: flex;
      flex-direction: column-reverse; /* Layer 7 at the top */
      align-items: center;
      gap: 4px;
      margin: 20px 0 30px 0;
      perspective: 1000px;
    }
    .visual-layer {
      width: 280px;
      padding: 10px;
      background: rgba(46, 46, 78, 0.6);
      border: 1px solid rgba(138, 138, 255, 0.3);
      border-radius: 6px;
      text-align: center;
      font-weight: 600;
      color: #d7d7ff;
      backdrop-filter: blur(5px);
    }

    /* --- Difficulty Selection Styles --- */
    .difficulty-options {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin: 30px 0;
    }

    .difficulty-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 150px;
      height: 150px;
      background: linear-gradient(45deg, #2e2e4e, #4a4ad8);
      border: 2px solid rgba(138, 138, 255, 0.3);
      border-radius: 15px;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }

    .difficulty-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
      background: linear-gradient(45deg, #4a4ad8, #6a6af8);
    }

    .difficulty-title {
      font-size: 1.5rem;
      margin-bottom: 10px;
    }

    .difficulty-desc {
      font-size: 1rem;
      opacity: 0.8;
    }

    .back-btn {
      display: block;
      width: 180px;
      margin: 20px auto 0;
      padding: 12px 0;
      background: transparent;
      border: 2px solid #5b5bc8;
      border-radius: 10px;
      color: #5b5bc8;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: #5b5bc8;
      color: #fff;
    }

    @media (max-width: 480px) {
      .difficulty-options {
        flex-direction: column;
        align-items: center;
      }
      
      .difficulty-btn {
        width: 200px;
        height: 100px;
        flex-direction: row;
      }
      
      .difficulty-title {
        font-size: 1.2rem;
        margin-right: 15px;
        margin-bottom: 0;
      }
    }
  </style>
</head>
<body>

  <!-- Start Page Container -->
  <div id="start-page-container" class="game-container">
    <h1 class="game-title">OSI Layer Quiz Game</h1>
    <p style="text-align: center; font-size: 1.1rem; color: #b0c4de; margin-bottom: 30px;">
      Journey through the 7 layers of the network.
    </p>
    
    <!-- Visual representation of the layers -->
    <div id="layer-visual-stack">
      <div class="visual-layer">Layer 7 - Application</div>
      <div class="visual-layer">Layer 6 - Presentation</div>
      <div class="visual-layer">Layer 5 - Session</div>
      <div class="visual-layer">Layer 4 - Transport</div>
      <div class="visual-layer">Layer 3 - Network</div>
      <div class="visual-layer">Layer 2 - Data Link</div>
      <div class="visual-layer">Layer 1 - Physical</div>
    </div>

    <button id="startGameBtn">Start Game</button>
  </div>

  <!-- Difficulty Selection Container -->
  <div id="difficulty-container" class="game-container hidden">
    <h1 class="game-title">Select Difficulty</h1>
    <p style="text-align: center; font-size: 1.1rem; color: #b0c4de; margin-bottom: 30px;">
      Choose your challenge level:
    </p>
    
    <div class="difficulty-options">
      <button class="difficulty-btn" data-questions="3">
        <span class="difficulty-title">Easy</span>
        <span class="difficulty-desc">3 Questions</span>
      </button>
      <button class="difficulty-btn" data-questions="6">
        <span class="difficulty-title">Medium</span>
        <span class="difficulty-desc">6 Questions</span>
      </button>
      <button class="difficulty-btn" data-questions="11">
        <span class="difficulty-title">Hard</span>
        <span class="difficulty-desc">11 Questions</span>
      </button>
    </div>
    
    <button id="backToStartBtn" class="back-btn">Back to Start</button>
  </div>

  <!-- Game Container is now hidden by default -->
  <div id="game-container" class="game-container hidden">
    <h1 class="game-title">OSI Layer Quiz Game</h1>
    <div id="questionNumber"></div>
    <div class="progress-container" id="progressContainer"></div>
    <div class="progress-legend" id="progressLegend">
      <div class="progress-legend-item"><div class="legend-dot" style="background-color: #3c3c3c;"></div>Unanswered</div>
      <div class="progress-legend-item"><div class="legend-dot" style="background-color: #5b5bc8;"></div>Current</div>
      <div class="progress-legend-item"><div class="legend-dot" style="background-color: #28a745;"></div>Correct</div>
      <div class="progress-legend-item"><div class="legend-dot" style="background-color: #dc3545;"></div>Incorrect</div>
    </div>
    <div id="question"></div>
    <ul class="OSI-Layers">
      <li data-layer="1" tabindex="0">Layer 1 - Physical</li>
      <li data-layer="2" tabindex="0">Layer 2 - Data Link</li>
      <li data-layer="3" tabindex="0">Layer 3 - Network</li>
      <li data-layer="4" tabindex="0">Layer 4 - Transport</li>
      <li data-layer="5" tabindex="0">Layer 5 - Session</li>
      <li data-layer="6" tabindex="0">Layer 6 - Presentation</li>
      <li data-layer="7" tabindex="0">Layer 7 - Application</li>
    </ul>
    <div id="feedback" aria-live="polite"></div>
    <div id="score" aria-live="polite"></div>
    <div id="highScore" aria-live="polite"></div>
    <div id="timer">Time remaining: 15s</div>
    <div id="timerBar">
      <div id="timerProgress" style="width: 100%;"></div>
    </div>
    
    <!-- Game Controls Container -->
    <div class="game-controls-container">
      <button id="backToDifficultyBtn">Back</button>
      <button id="restartBtn">Restart</button>
    </div>
  </div>

  <div class="confetti-container" id="confettiContainer"></div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const allQuestions = [
        { question: "Which layer is responsible for physical transmission?", answer: "1" },
        { question: "Which layer ensures error-free data transfer?", answer: "2" },
        { question: "Which layer handles routing?", answer: "3" },
        { question: "Which layer ensures reliable delivery?", answer: "4" },
        { question: "Which layer manages sessions?", answer: "5" },
        { question: "Which layer handles translation and encryption?", answer: "6" },
        { question: "Which layer interacts with software apps?", answer: "7" },
        { question: "Where does IP addressing occur?", answer: "3" },
        { question: "Where does MAC addressing occur?", answer: "2" },
        { question: "Where does segmentation happen?", answer: "4" },
        { question: "Which layer deals with bitstream transmission?", answer: "1" },
      ];

      let questions = [];
      let currentQuestion = 0;
      let correctAnswers = 0;
      let baseTime = 15;
      let timerSpeedFactor = 1;
      let questionAnswered = false;
      let gameOver = false;
      let highScore = 0;
      let questionResults = []; // Store true for correct, false for incorrect

      // Variables for difficulty
      let totalQuestions = 11; // Default to hard mode
      let difficultyLevel = "Hard";

      let startTime = 0;
      let timerInterval;

      // Get element selectors
      const startPageContainer = document.getElementById("start-page-container");
      const difficultyContainer = document.getElementById("difficulty-container");
      const gameContainer = document.getElementById("game-container");
      const startGameBtn = document.getElementById("startGameBtn");
      const difficultyBtns = document.querySelectorAll(".difficulty-btn");
      const backToStartBtn = document.getElementById("backToStartBtn");
      const backToDifficultyBtn = document.getElementById("backToDifficultyBtn");
      
      const questionNumberEl = document.getElementById("questionNumber");
      const questionEl = document.getElementById("question");
      const feedbackEl = document.getElementById("feedback");
      const scoreEl = document.getElementById("score");
      const highScoreEl = document.getElementById("highScore");
      const timerEl = document.getElementById("timer");
      const timerProgressEl = document.getElementById("timerProgress");
      const restartBtn = document.getElementById("restartBtn");
      const layerLis = document.querySelectorAll(".OSI-Layers li");
      const confettiContainer = document.getElementById("confettiContainer");
      const progressContainer = document.getElementById("progressContainer");
      const progressLegend = document.getElementById("progressLegend");

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }

      function initializeProgressDots() {
        progressContainer.innerHTML = "";
        for (let i = 0; i < questions.length; i++) {
          const dot = document.createElement("div");
          dot.className = "progress-dot";
          progressContainer.appendChild(dot);
        }
        updateProgressDots();
      }

      function updateProgressDots() {
        const dots = progressContainer.querySelectorAll(".progress-dot");
        dots.forEach((dot, index) => {
          dot.classList.remove("active", "completed", "incorrect");
          if (index < currentQuestion) {
            if (questionResults[index] === true) {
              dot.classList.add("completed");
            } else {
              dot.classList.add("incorrect");
            }
          } else if (index === currentQuestion) {
            dot.classList.add("active");
          }
        });
      }

      function loadQuestion() {
        if (gameOver) return;
        
        // FIX: Added a safety check to prevent errors if a question is missing.
        if (!questions[currentQuestion]) {
          console.error("Question not found! Ending game to prevent crash.");
          gameOver = true;
          showFinalScore();
          return;
        }

        questionAnswered = false;
        clearSelection();
        removeCorrectHighlight();

        questionNumberEl.innerText = `Question ${currentQuestion + 1}/${questions.length}`;
        questionEl.innerText = questions[currentQuestion].question;
        feedbackEl.innerHTML = "";
        feedbackEl.className = "";
        enableLayers(true);

        startTime = Date.now();
        
        // Adjust base time based on difficulty
        let adjustedBaseTime = baseTime;
        if (totalQuestions === 3) {
          adjustedBaseTime = 20; // More time for easy mode
        } else if (totalQuestions === 6) {
          adjustedBaseTime = 18; // Slightly more time for medium mode
        }

        updateTimerDisplay(adjustedBaseTime);
        startTimer(adjustedBaseTime);
        
        updateProgressDots();
      }

      function updateTimerDisplay(customBaseTime) {
        const elapsedMs = Date.now() - startTime;
        const baseTimeToUse = customBaseTime || baseTime;
        let timeLeft = Math.ceil(baseTimeToUse * timerSpeedFactor - elapsedMs / 1000);

        if (timeLeft < 0) timeLeft = 0;

        timerEl.innerText = `Time remaining: ${timeLeft}s`;
        const progressWidth = (timeLeft / (baseTimeToUse * timerSpeedFactor)) * 100;
        timerProgressEl.style.width = progressWidth + "%";

        return timeLeft;
      }

      function startTimer(customBaseTime) {
        clearInterval(timerInterval);
        const baseTimeToUse = customBaseTime || baseTime;
        timerInterval = setInterval(() => {
          const timeLeft = updateTimerDisplay(baseTimeToUse);
          if (timeLeft <= 0 && !questionAnswered) {
            clearInterval(timerInterval);
            questionAnswered = true;
            questionResults.push(false); // Record as incorrect
            showFeedback(false, "Time's up! Moving to next question.", true);
            enableLayers(false);
            setTimeout(nextQuestion, 2000);
          }
        }, 200);
      }

      function showFeedback(isCorrect, message, highlightCorrect = false) {
        feedbackEl.className = isCorrect ? "correct-feedback animated" : "incorrect-feedback animated";
        feedbackEl.innerText = message;

        if (highlightCorrect) {
          highlightCorrectAnswer();
        }
      }

      // Update score to show percentage
      function updateScore() {
        const percentage = questions.length > 0 ? 
          Math.round((correctAnswers / questions.length) * 100) : 0;
        
        scoreEl.innerText = `Correct Answers: ${correctAnswers}/${questions.length} (${percentage}%)`;
        highScoreEl.innerText = `High Score: ${highScore}`;
      }

      function getHighScore() {
        return parseInt(localStorage.getItem("osiQuizHighScore") || "0", 10);
      }

      function saveHighScore(score) {
        const currentHigh = getHighScore();
        if (score > currentHigh) {
          localStorage.setItem("osiQuizHighScore", score.toString());
          return true;
        }
        return false;
      }

      function nextQuestion() {
        currentQuestion++;
        if (currentQuestion >= questions.length) {
          gameOver = true;
          showFinalScore();
        } else {
          loadQuestion();
        }
      }

      // FIX: Updated final score logic to show confetti for a perfect score
      function showFinalScore() {
        clearInterval(timerInterval);
        questionNumberEl.innerText = "Quiz Complete!";
        
        const percentage = Math.round((correctAnswers / questions.length) * 100);
        questionEl.innerText = 
          `Your final score: ${correctAnswers} out of ${questions.length} (${percentage}%)`;
        
        const isNewHighScore = saveHighScore(correctAnswers);
        highScore = getHighScore();
        updateScore();
        
        progressLegend.style.display = "none"; // Hide legend at the end
        updateProgressDots(); // Update dots to show final results

        // FIX: Trigger confetti for a new high score OR a perfect score (100%)
        if (isNewHighScore) {
          feedbackEl.innerText = "Congratulations! You've set a new high score!";
          feedbackEl.className = "correct-feedback animated new-high-score";
          createConfetti();
        } else if (percentage === 100) {
          feedbackEl.innerText = "Perfect score! Well done!";
          feedbackEl.className = "correct-feedback animated new-high-score"; // Use same styling for celebration
          createConfetti();
        } else {
          feedbackEl.innerText = "Click Restart to play again.";
          feedbackEl.className = "";
        }

        enableLayers(false);
      }

      function enableLayers(enabled) {
        layerLis.forEach(li => {
          li.style.pointerEvents = enabled ? "auto" : "none";
          li.setAttribute("aria-disabled", !enabled);
          li.tabIndex = enabled ? 0 : -1;
        });
      }

      function clearSelection() {
        layerLis.forEach(li => li.classList.remove("selected"));
      }

      function highlightCorrectAnswer() {
        const correctLayer = questions[currentQuestion].answer;
        layerLis.forEach(li => {
          if (li.getAttribute("data-layer") === correctLayer) {
            li.classList.add("correct-answer");
          }
        });
      }

      function removeCorrectHighlight() {
        layerLis.forEach(li => li.classList.remove("correct-answer"));
      }

      // FIX: Updated createConfetti function for a smoother animation
      function createConfetti() {
        confettiContainer.style.display = 'block';
        confettiContainer.innerHTML = '';
        
        const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', 
                        '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50', 
                        '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800'];
        
        for (let i = 0; i < 150; i++) { // Increased from 100 to 150
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
          confetti.style.opacity = Math.random();
          confettiContainer.appendChild(confetti);
        }
        
        // FIX: Increased timeout to ensure all animations can finish
        setTimeout(() => {
          confettiContainer.style.display = 'none';
        }, 6000); // Increased from 5000 to 6000ms
      }

      function handleAnswer(layerNumber, liElement) {
        if (questionAnswered || gameOver) return;
        questionAnswered = true;
        clearInterval(timerInterval);

        const isCorrect = (layerNumber === questions[currentQuestion].answer);
        questionResults.push(isCorrect);

        if (isCorrect) {
          correctAnswers++;
          showFeedback(true, "Correct! ðŸŽ‰");
          timerSpeedFactor = Math.max(0.7, timerSpeedFactor - 0.1);
        } else {
          showFeedback(false, `Incorrect. The correct answer was Layer ${questions[currentQuestion].answer}.`, true);
          timerSpeedFactor = Math.min(1.5, timerSpeedFactor + 0.2);
        }
        updateScore();
        enableLayers(false);
        liElement.classList.add("selected");
        setTimeout(nextQuestion, 2000);
      }

      // Function to show difficulty selection
      function showDifficultySelection() {
        startPageContainer.classList.add("hidden");
        difficultyContainer.classList.remove("hidden");
        gameContainer.classList.add("hidden");
      }

      // Function to handle difficulty selection
      function selectDifficulty(numQuestions) {
        totalQuestions = numQuestions;
        
        // Set difficulty level text based on number of questions
        if (numQuestions === 3) {
          difficultyLevel = "Easy";
        } else if (numQuestions === 6) {
          difficultyLevel = "Medium";
        } else {
          difficultyLevel = "Hard";
        }
        
        // Show the game with the selected difficulty
        difficultyContainer.classList.add("hidden");
        gameContainer.classList.remove("hidden");
        startGame();
      }

      // The startGame function now uses the selected number of questions
      function startGame() {
        clearInterval(timerInterval);
        
        // FIX: Shuffle the entire pool of questions first, then take a slice.
        const shuffledAllQuestions = [...allQuestions];
        shuffleArray(shuffledAllQuestions);
        questions = shuffledAllQuestions.slice(0, totalQuestions);
        
        currentQuestion = 0;
        correctAnswers = 0;
        gameOver = false;
        timerSpeedFactor = 1;
        questionResults = []; // Reset results
        highScore = getHighScore();
        updateScore();
        initializeProgressDots();
        loadQuestion();
        feedbackEl.innerText = "";
        confettiContainer.style.display = "none";
        progressLegend.style.display = "flex"; // Show legend at the start
        
        // Update the game title to show difficulty
        document.querySelector("#game-container .game-title").innerText = 
          `OSI Layer Quiz - ${difficultyLevel}`;
      }

      layerLis.forEach(li => {
        li.addEventListener("click", () => {
          if (li.classList.contains("disabled")) return;
          const layerNum = li.getAttribute("data-layer");
          handleAnswer(layerNum, li);
        });
        li.addEventListener("keydown", e => {
          if ((e.key === "Enter" || e.key === " ") && !li.classList.contains("disabled")) {
            e.preventDefault();
            const layerNum = li.getAttribute("data-layer");
            handleAnswer(layerNum, li);
          }
        });
      });

      // Event listeners
      startGameBtn.addEventListener("click", showDifficultySelection);

      difficultyBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          const numQuestions = parseInt(btn.getAttribute("data-questions"));
          selectDifficulty(numQuestions);
        });
      });

      backToStartBtn.addEventListener("click", () => {
        difficultyContainer.classList.add("hidden");
        startPageContainer.classList.remove("hidden");
      });

      // Event listener for the new Back button
      backToDifficultyBtn.addEventListener("click", () => {
        clearInterval(timerInterval); // Stop the timer
        gameContainer.classList.add("hidden");
        showDifficultySelection();
      });

      // The "Restart" button now restarts the same game
      restartBtn.addEventListener("click", () => {
        startGame();
      });

      // Initial UI setup for the hidden game container
      questionNumberEl.innerText = "";
      questionEl.innerText = "Click Start to begin the OSI Layer Quiz!";
      feedbackEl.innerText = "";
      scoreEl.innerText = "";
      highScoreEl.innerText = "";
      timerEl.innerText = "";
      timerProgressEl.style.width = "0%";
      enableLayers(false);
      highScore = getHighScore();
      updateScore();
      progressLegend.style.display = "none"; // Hide legend initially
    });
  </script>
</body>
</html>
